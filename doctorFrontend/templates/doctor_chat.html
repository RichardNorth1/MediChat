<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="chat-container">
        <div class="sidebar">
            <h2>Waiting Patients</h2>
            <ul id="lobby"></ul>
            <h2>Escalated Chats</h2>
            <ul id="escalated-chats"></ul>
        </div>

        <div class="chat-window">
            <div id="messages" class="messages"></div>
            <div id="typing-indicator" class="typing-indicator" style="display: none;">Patient is typing...</div>
            <div class="input-area">
                <input type="text" id="input" placeholder="Type a message...">
                <button id="send">Send</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize variables
        let chatHistory = {};
        let currentChat = null;
        let socket;
        let doctorId = "";

        // Function to generate a unique UUID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Function to show the typing indicator
        function showTypingIndicator() {
            document.getElementById('typing-indicator').style.display = 'block';
        }

        // Function to hide the typing indicator
        function hideTypingIndicator() {
            document.getElementById('typing-indicator').style.display = 'none';
        }

        // Function to load the lobby data
        async function loadLobby() {
            const response = await fetch('http://localhost:8000/api/lobby');
            const lobbyList = document.getElementById('lobby');
            lobbyList.innerHTML = '';

            const data = await response.json();
            console.log('Lobby Data:', data);

            if (data && Array.isArray(data.lobby)) {
                data.lobby.forEach(patient => {
                    if (patient.patient_id) {
                        const item = document.createElement('li');
                        item.textContent = `Patient ID: ${patient.patient_id}`;
                        const claimButton = document.createElement('button');
                        claimButton.textContent = "Claim";
                        claimButton.onclick = () => claimPatient(patient.patient_id);
                        item.appendChild(claimButton);
                        lobbyList.appendChild(item);
                    } 
                });
            }
        }

        // Function to claim a patient
        function claimPatient(patientId) {
            console.log(`Claiming patient with ID: ${patientId}`);
            socket.send(JSON.stringify({ type: "claim", patient_id: patientId }));

            const lobbyList = document.getElementById('lobby');
            const escalatedList = document.getElementById('escalated-chats');

            const claimedItem = [...lobbyList.children].find(item => item.textContent.includes(patientId));
            if (claimedItem) {
                lobbyList.removeChild(claimedItem);
                
                const escalatedItem = document.createElement('li');
                escalatedItem.textContent = `Patient ID: ${patientId}`;
                escalatedItem.onclick = () => startChat(patientId);
                escalatedList.appendChild(escalatedItem);
            }
        }

        // Function to load escalated chats
        async function loadEscalatedChats() {
            const response = await fetch('http://localhost:8000/api/escalated_chats');
            const list = document.getElementById('escalated-chats');
            list.innerHTML = '';

            const chats = await response.json();
            if (chats && Array.isArray(chats)) {
                chats.forEach(chat => {
                    if (chat.client_id) {
                        const item = document.createElement('li');
                        item.textContent = `Patient ID: ${chat.client_id}`;
                        item.onclick = () => startChat(chat.client_id);
                        list.appendChild(item);
                    }
                });
            }
        }

        // Function to start a chat with a patient
        function startChat(clientId) {
            if (currentChat === clientId) return;
            console.log(`Switching to chat with client ID: ${clientId}`);
            if (socket) {
                socket.close();
            }

            document.getElementById('messages').innerHTML = '';
            currentChat = clientId;
            console.log(`Current chat set to: ${currentChat}`);

            if (localStorage.getItem(`chatHistory_${clientId}`)) {
                chatHistory[clientId] = JSON.parse(localStorage.getItem(`chatHistory_${clientId}`));
                chatHistory[clientId].forEach(msg => {
                    const messageElement = document.createElement('div');
                    messageElement.classList.add('message', msg.type);
                    messageElement.textContent = msg.content;
                    document.getElementById('messages').appendChild(messageElement);
                });
            } else {
                chatHistory[clientId] = [];
            }

            socket = new WebSocket(`ws://localhost:8000/ws/doctor/${doctorId}`);
            console.log(`WebSocket connected for doctor ${doctorId} with patient ${clientId}`);

            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('WebSocket message received:', data);

                if (data.type === "lobby_update") {
                    loadLobby();
                }

                if (data.type === "assigned" && data.doctor_id === doctorId) {
                    alert(`You have been assigned a patient!`);
                    loadEscalatedChats();
                }

                if (data.status === "typing") {
                    if (data.sender === "patient") {
                        console.log('Received typing status from patient');
                        showTypingIndicator();
                        setTimeout(hideTypingIndicator, 3000);
                    }
                    return;
                }

                if (data.status === "form_data") {
                    console.log(data);
                    const formData = data.data;
                    const formMessage = `Patient Details:\nName: ${formData.name}\nAge: ${formData.age}\nSymptoms: ${formData.symptoms}`;
                    const messageElement = document.createElement('div');
                    messageElement.classList.add('message', 'incoming');
                    messageElement.textContent = formMessage;
                    document.getElementById('messages').appendChild(messageElement);
                    scrollToBottom();
                    return;
                }

                const messageElement = document.createElement('div');
                messageElement.classList.add('message', 'incoming');
                messageElement.textContent = data.message;
                document.getElementById('messages').appendChild(messageElement);
                scrollToBottom();
                hideTypingIndicator();

                if (!chatHistory[currentChat]) {
                    chatHistory[currentChat] = [];
                }
                chatHistory[currentChat].push({ type: 'incoming', content: data.message });
                localStorage.setItem(`chatHistory_${currentChat}`, JSON.stringify(chatHistory[currentChat]));
            };

            const sendMessage = function() {
                const message = document.getElementById('input').value;
                if (message.trim() === "") return;
                console.log(`Sending message to patient ${currentChat}: ${message}`);
                socket.send(JSON.stringify({ message: message, sender: "doctor", patient_id: currentChat }));
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', 'outgoing');
                messageElement.textContent = message;
                document.getElementById('messages').appendChild(messageElement);
                if (!chatHistory[currentChat]) {
                    chatHistory[currentChat] = [];
                }
                chatHistory[currentChat].push({ type: 'outgoing', content: message });
                localStorage.setItem(`chatHistory_${currentChat}`, JSON.stringify(chatHistory[currentChat]));
                document.getElementById('input').value = '';
                scrollToBottom();
            };

            document.getElementById('send').onclick = sendMessage;
            document.getElementById('input').addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    sendMessage();
                    event.preventDefault();
                } else {
                    console.log('Doctor is typing');
                    socket.send(JSON.stringify({ status: "typing", sender: "doctor", patient_id: currentChat }));
                }
            });

            loadEscalatedChats();
        }

        // Function to scroll to the bottom of the messages
        function scrollToBottom() {
            const messages = document.getElementById('messages');
            messages.scrollTop = messages.scrollHeight;
        }

        // Function to start the WebSocket connection
        function startWebSocket() {
            socket = new WebSocket(`ws://localhost:8000/ws/doctor/${doctorId}`);

            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);

                console.log('Received WebSocket message:', data);

                if (data.type === "lobby_update") {
                    loadLobby();
                }

                if (data.type === "assigned" && data.doctor_id === doctorId) {
                    alert(`You have been assigned a patient!`);
                    loadEscalatedChats();
                }

                if (data.message) {
                    const messageElement = document.createElement('div');
                    messageElement.classList.add('message', 'incoming');
                    messageElement.textContent = data.message;
                    document.getElementById('messages').appendChild(messageElement);
                }
            };
        }

        // Initialize the WebSocket connection and load initial data when the document is ready
        document.addEventListener("DOMContentLoaded", () => {
            doctorId = generateUUID();
            console.log(`Doctor ID generated: ${doctorId}`);
            startWebSocket();
            loadLobby();
            loadEscalatedChats();
            setInterval(loadLobby, 5000);
        });
    </script>
</body>
</html>