<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="chat-container">
        <div class="message-list" id="message-list" style="overflow-y: auto; height: 80vh;"></div>
        <div id="typing-indicator" class="typing-indicator" style="display: none;">Chatbot is typing...</div>
        <div id="doctor-typing-text" class="typing-indicator" style="display: none;">Doctor is typing...</div>
        <div class="input-container">
            <input type="text" id="message-input" placeholder="Type a message...">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        let ws;
        let chatId = "";
        let endpoint = "chatbot";
        let typingTimeout;
        let isWebSocketOpen = false;

        function generateUUID() {
            chatId = crypto.randomUUID();
            console.log("Generated chat ID:", chatId);
        }

        function showDoctorTypingIndicator() {
            document.getElementById('doctor-typing-text').style.display = 'block';
        }

        function showChatbotTypingIndicator() {
            document.getElementById('typing-indicator').style.display = 'block';
        }

        function hideDoctorTypingIndicator() {
            document.getElementById('doctor-typing-text').style.display = 'none';
        }

        function hideChatbotTypingIndicator() {
            document.getElementById('typing-indicator').style.display = 'none';
        }

        function connectWebSocket() {
            if (isWebSocketOpen) {
                console.log("WebSocket is already open");
                return;  // Don't open a new connection if one is already active
            }

            if (!chatId) {
                console.error('Chat ID is not set');
                return;
            }

            ws = new WebSocket(`ws://localhost:8000/ws/${endpoint}/${chatId}`);
            console.log('websocket = ', ws);
            console.log('endpoint = ', endpoint);

            ws.onopen = function() {
                isWebSocketOpen = true;
                console.log('WebSocket connection established');
            };

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('Received message:', data);
                
                if (data.status === "typing") {
                    console.log('Typing indicator received');
                    if (data.sender === "chatbot") {
                        showChatbotTypingIndicator();
                        setTimeout(hideChatbotTypingIndicator, 3000);
                    } else if (data.sender === "doctor") {
                        showDoctorTypingIndicator();
                        setTimeout(hideDoctorTypingIndicator, 3000);
                    }
                    return;
                }

                // Handle escalation to doctor
                if (data.status === "escalated") {
                    console.log('Conversation escalated, switching to doctor chat...');
                    connectDoctorWebSocket(data.client_id);
                    endpoint = "doctor";
                    return;
                }

                const message = data.message || "No message received";
                addMessageToList(message, data.sender === "doctor" ? 'doctor-message' : 'bot-message');
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };

            ws.onclose = function() {
                console.log('WebSocket connection closed');
                isWebSocketOpen = false;
                // Attempt to reconnect
                setTimeout(connectWebSocket, 1000);
            };
        }

        function connectDoctorWebSocket(clientId) {
            console.log("Attempting to connect to doctor WebSocket with clientId:", clientId);

            if (ws) {
                ws.close();
            }

            let endpoint = "doctor";

            ws = new WebSocket(`ws://localhost:8000/ws/${endpoint}/${clientId}`);

            ws.onopen = function() {
                console.log('Doctor WebSocket connection established');
            };

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.status === "typing") {
                    if (data.sender === "doctor") {
                        showDoctorTypingIndicator();
                        setTimeout(hideDoctorTypingIndicator, 3000);
                    } else if (data.sender === "chatbot") {
                        showChatbotTypingIndicator();
                        setTimeout(hideChatbotTypingIndicator, 3000);
                    }
                    return;
                }

                const message = data.message || "No message received";
                addMessageToList(message, data.sender === "doctor" ? 'doctor-message' : 'bot-message');
            };

            ws.onerror = function(error) {
                console.error('Doctor WebSocket error:', error);
            };

            ws.onclose = function() {
                console.log('Doctor WebSocket connection closed');
                isWebSocketOpen = false;
                // Attempt to reconnect
                setTimeout(() => connectDoctorWebSocket(clientId), 1000);
            };
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value;
            if (message.trim()) {
                console.log('Sending message:', message);
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ message: message, sender: "patient" }));
                    addMessageToList(message, 'user-message');
                    input.value = '';
                } else {
                    console.error('WebSocket is not open');
                }
            }
        }

        function addMessageToList(message, sender) {
            console.log('Adding message:', message); // Log message before appending to the DOM

            const messageList = document.getElementById('message-list');
            const lastMessage = messageList.lastElementChild;

            // Check if the last message is from the same sender and contains the same text
            if (lastMessage && lastMessage.textContent === message && lastMessage.classList.contains(sender)) {
                console.log('Duplicate message from the same sender, not adding.');
                return;
            }

            const messageElement = document.createElement('div');
            messageElement.className = `message ${sender}`;
            messageElement.textContent = message;
            messageList.appendChild(messageElement);

            messageList.scrollTop = messageList.scrollHeight;
        }


        document.getElementById('message-input').addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
                event.preventDefault();
            } else {
                console.log('Typing');
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ status: "typing", sender: "patient" }));
                }
            }
        });

        window.onload = function() {
            generateUUID();
            connectWebSocket();
        };
    </script>
</body>
</html>
