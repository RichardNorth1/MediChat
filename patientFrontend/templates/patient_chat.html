<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="chat-container">
        <div class="message-list" id="message-list" style="overflow-y: auto; height: 80vh;"></div>
        <div class="modal-overlay" id="modal-overlay" style="display: none;"></div>

        <div class="modal" id="modal-form" style="display: none;">
            <div class="modal-content">
                <h3>Provide Your Details</h3>
                <form id="patient-form" onsubmit="submitForm(event)">
                    <label for="name">Name:</label>
                    <input type="text" id="name" name="name" placeholder="Your name" required>
                    
                    <label for="age">Age:</label>
                    <input type="number" id="age" name="age" placeholder="Your age" required>
                    
                    <label for="symptoms">Symptoms:</label>
                    <textarea id="symptoms" name="symptoms" rows="4" placeholder="Describe your symptoms" required></textarea>
                    
                    <div class="modal-buttons">
                        <button type="button" onclick="closeModal()">Cancel</button>
                        <button type="submit">Submit</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="typing-indicator" class="typing-indicator" style="display: none;">Chatbot is typing...</div>
        <div id="doctor-typing-text" class="typing-indicator" style="display: none;">Doctor is typing...</div>
        <div class="input-container">
            <input type="text" id="message-input" placeholder="Type a message...">
            <button onclick="sendMessage()">Send</button>
        </div>
        
    </div>

    <script>
        let socket;
        let patientSocket = null;
        let chatId = "";
        let isWebSocketOpen = false;

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function showDoctorTypingIndicator() {
            document.getElementById('doctor-typing-text').style.display = 'block';
        }

        function showChatbotTypingIndicator() {
            document.getElementById('typing-indicator').style.display = 'block';
        }

        function hideDoctorTypingIndicator() {
            document.getElementById('doctor-typing-text').style.display = 'none';
        }

        function hideChatbotTypingIndicator() {
            document.getElementById('typing-indicator').style.display = 'none';
        }

        function showModal() {
            document.getElementById('modal-overlay').style.display = 'block';
            document.getElementById('modal-form').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
            document.getElementById('modal-form').style.display = 'none';
        }

        function submitForm(event) {
            event.preventDefault(); 

            const name = document.getElementById('name').value.trim();
            const age = document.getElementById('age').value.trim();
            const symptoms = document.getElementById('symptoms').value.trim();

            if (name && age && symptoms) {
                const formData = {
                    name,
                    age,
                    symptoms,
                };

                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ status: "form_data", data: formData }));
                }

                closeModal();

                alert("Form submitted successfully. A doctor will review your details.");
            } else {
                alert("Please fill in all fields before submitting.");
            }
        }

        function connectWebSocket() {
            socket = new WebSocket(`ws://localhost:8000/ws/chatbot/${chatId}`);            
            socket.onopen = function() {
                isWebSocketOpen = true;
            };

            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);

                if (data.status === "typing") {
                    if (data.sender === "chatbot") {
                        showChatbotTypingIndicator();
                        setTimeout(hideChatbotTypingIndicator, 6000);
                    } else if (data.sender === "doctor") {
                        showDoctorTypingIndicator();
                        setTimeout(hideDoctorTypingIndicator, 3000);
                    }
                    return;
                }

                if (data.status === "escalated") {
                    
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        socket.close();
                        isWebSocketOpen = false; 
                    }
                    connectToPatientChat(chatId);
                    showModal();
                    return;
                }

                const message = data.message || "No message received";
                addMessageToList(message, data.sender === "doctor" ? 'doctor-message' : 'bot-message');
            };

            socket.onclose = function() {
                isWebSocketOpen = false;
                setTimeout(connectWebSocket, 1000);
            };
        }

        function connectToPatientChat(chatId) {
            patientSocket = new WebSocket(`ws://localhost:8000/ws/patient/${chatId}`);

            patientSocket.onopen = function() {
                isWebSocketOpen = true; 
            };

            patientSocket.onmessage = function(event) {
                const data = JSON.parse(event.data);

                if (data.status === "typing") {
                    if (data.sender === "doctor") {
                        showDoctorTypingIndicator();
                        setTimeout(hideDoctorTypingIndicator, 3000);
                    }
                    return;
                }

                const message = data.message || "No message received";
                addMessageToList(message, 'doctor-message');
            };

            patientSocket.onclose = function() {
                isWebSocketOpen = false;
            };
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value;
            if (message.trim()) {
                if (patientSocket && patientSocket.readyState === WebSocket.OPEN) {
                    patientSocket.send(JSON.stringify({ message: message, sender: "patient" }));
                    addMessageToList(message, 'user-message');
                    input.value = '';
                } else if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ message: message, sender: "patient" }));
                    addMessageToList(message, 'user-message');
                    input.value = '';
                }
            }
        }

        function addMessageToList(message, sender) {

            const messageList = document.getElementById('message-list');

            const messageElement = document.createElement('div');
            messageElement.className = `message ${sender}`;
            messageElement.textContent = message;
            messageList.appendChild(messageElement);

            messageList.scrollTop = messageList.scrollHeight;
        }

        document.getElementById('message-input').addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
                event.preventDefault();
            } else {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ status: "typing", sender: "patient" }));
                } else if (patientSocket && patientSocket.readyState === WebSocket.OPEN) {
                    patientSocket.send(JSON.stringify({ status: "typing", sender: "patient" }));
                }
            }
        });

        window.onload = function() {
            chatId = generateUUID();
            connectWebSocket();
        };
    </script>
</body>
</html>