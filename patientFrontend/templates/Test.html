<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="chat-container">
        <div class="message-list" id="message-list" style="overflow-y: auto; height: 80vh;"></div>
        <div id="typing-indicator" class="typing-indicator" style="display: none;">Chatbot is typing...</div>
        <div id="doctor-typing-text" class="typing-indicator" style="display: nfone;">Doctor is typing...</div>
        <div class="input-container">
            <input type="text" id="message-input" placeholder="Type a message...">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        let ws;
        let chatId = "";
        let endpoint = "chatbot";
        let typingTimeout;

        function generateUUID() {
            chatId = crypto.randomUUID();
            console.log("Generated chat ID:", chatId);
        }
        function showDoctorTypingIndicator() {
            console.log('showdoctor');
            document.getElementById('doctor-typing-text').style.display = 'block';
        }

        function showChatbotTypingIndicator() {
            document.getElementById('chatbot-typing-text').style.display = 'block';
        }

        function hideDoctorTypingIndicator() {
            console.log('hidedoctor');
            document.getElementById('doctor-typing-text').style.display = 'none';
        }

        function hideChatbotTypingIndicator() {
            document.getElementById('chatbot-typing-indicator').style.display = 'none';
        }

        // function showTypingIndicator(sender) {
        //     // const typingText = document.getElementById('typing-text');
        //     // typingText.textContent = sender === 'bot' ? "Chatbot is typing..." : "Doctor is typing...";
        //     // const messageList = document.getElementById('message-list');
        //     messageList.scrollTop = messageList.scrollHeight;
        //     clearTimeout(typingTimeout);
        //     typingTimeout = setTimeout(removeTypingIndicator, 3000);
        // }

        // function showBlock() {
        //     document.getElementById('typing-indicator').style.display = 'block';

        // }

        // function removeTypingIndicator() {
        //     const typingIndicator = document.getElementById('typing-indicator');
        //     if (typingIndicator) {
        //         typingIndicator.style.display = 'none';
        //     }
        // }

        function connectWebSocket() {
            if (!chatId) {
                console.error('Chat ID is not set');
                return;
            }

            ws = new WebSocket(`ws://localhost:8000/ws/${endpoint}/${chatId}`);
            console.log('websocket = ', ws);
            console.log('endpoint = ', endpoint);

            ws.onopen = function() {
                console.log('WebSocket connection established');
            };

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('data = ', data);
                if (data.status === "typing") {
                    if (endpoint === "chatbot") {
                        console.log('in if')
                    } 
                    else {
                        console.log('in else')
                    }       
                    console.log(`${endpoint.charAt(0).toUpperCase() + endpoint.slice(1)} is typing...`);
                    return;
                }

                if (data.status === "escalated") {
                    console.log('Conversation escalated, switching to doctor chat...');
                    connectDoctorWebSocket(data.client_id);
                    endpoint = "doctor";
                    return;
                }

                const message = data.message || "No message received";
                console.log('Received message:', message);
                addMessageToList(message, 'bot-message');
                // hideChatbotTypingIndicator();
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };

            ws.onclose = function() {
                console.log('WebSocket connection closed');
            };
        }

        function connectDoctorWebSocket(clientId) {
            console.log("Attempting to connect to doctor WebSocket with clientId:", clientId);

            if (ws) {
                ws.close();
            }

            let endpoint = "doctor";

            ws = new WebSocket(`ws://localhost:8000/ws/${endpoint}/${clientId}`);

            ws.onopen = function() {
                console.log('Doctor WebSocket connection established');
                console.log('endpointdoc = ', endpoint);
            };

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);

                if (data.status === "typing"&& data.sender === "doctor") {
                    console.log("sender:" , data.sender);
                    showDoctorTypingIndicator();
                    setTimeout(hideDoctorTypingIndicator, 3000);
                    
                    return;
                }
                
                const message = data.message || "No message received";
                console.log('Doctor received message:', message);
                addMessageToList(message, 'doctor-message');
                // hideDoctorTypingIndicator();
            };


            document.getElementById('message-input').addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    sendMessage();
                    event.preventDefault();
                } else {
                    const typingMessage = JSON.stringify({
                        status: "typing",
                        sender: "patient",
                    });
                    ws.send(typingMessage); // Use 'ws' instead of 'socket'
                }
            });


            ws.onerror = function(error) {
                console.error('Doctor WebSocket error:', error);
            };

            ws.onclose = function() {
                console.log('Doctor WebSocket connection closed');
            };
        }

        const sendMessage = function() {
            const message = document.getElementById('input').value;
            if (message.trim() === "") return;

            const messagePayload = JSON.stringify({
                status: "message",
                sender: senderId,
                content: message,
            });

            ws.send(messagePayload);

            const messageElement = document.createElement('div');
            messageElement.classList.add('message', 'outgoing');
            messageElement.textContent = message;
            document.getElementById('messages').appendChild(messageElement);

            if (!chatHistory[currentChat]) {
                chatHistory[currentChat] = [];
            }
            chatHistory[currentChat].push({ type: 'outgoing', content: message });
            localStorage.setItem(`chatHistory_${currentChat}`, JSON.stringify(chatHistory[currentChat]));

            document.getElementById('input').value = '';
            scrollToBottom();
        };


        function addMessageToList(message, sender) {
            const messageList = document.getElementById('message-list');

            const messageElement = document.createElement('div');
            messageElement.className = `message ${sender}`;
            messageElement.textContent = message;
            messageList.appendChild(messageElement);

            messageList.scrollTop = messageList.scrollHeight;
        }

        // document.getElementById('message-input').addEventListener('keydown', function(event) {
        //     if (event.key === 'Enter') {
        //         sendMessage();
        //         event.preventDefault();
        //     }
        // });

        window.onload = function() {
            generateUUID();
            connectDoctorWebSocket();
        };
    </script>
</body>
</html>